---
title: "Quality Control and Library Composition Analysis"
subtitle: "Exploratory Analysis of RNA-Seq Data: LNCaP & PC3 under Hypoxic Stress"
author: "Nitin Beesabathuni"
date: "`r Sys.Date()`"
format: 
  gfm:
    toc: true
    toc-depth: 2
    code-fold: true
    theme: cosmo
---

Summary: This report details the initial Quality Control (QC) and exploratory analysis of transcriptomic data from LNCaP and PC3 prostate cancer cell lines under genetic perturbation (https://pubmed.ncbi.nlm.nih.gov/30655535/). The goal is to evaluate sequencing depth and library composition (Mitochondrial vs. Ribosomal content) across treatment/replicate conditions prior to differential expression analysis.

```{r}
#| results: false
#| message: false
# Load necessary library
library(tidyverse)
library(here)
library(conflicted)
library(DESeq2)
library(ggplot2)
library(ggpubr) 
library(scales) # For readable axis labels
library(gt)
# Resolve namespace conflicts
conflict_prefer("select", "dplyr")
conflict_prefer("filter", "dplyr")
conflicts_prefer(generics::setdiff)
```

## 1. Data Import and Preparation

Importing the annotated count matrix. Gene symbols are used as primary identifiers.

```{r}
# Loading cleaned and annotated data
# check.names = FALSE ensures sample IDs containing dashes/special characters remain intact
data <- read.csv("analysis_ready_count_data.csv", row.names = 1, check.names = FALSE)

# Display data structure
head(data) %>% gt(rownames_to_stub = TRUE)

```

## 2. Sequencing Depth & Replicate Consistency

Lets first evaluate the total read counts per sample to identify potential library size biases.

```{r}
#| fig-width: 10
#| fig-height: 5
#| fig-cap: "Figure 1: Total library sizes grouped by Cell Line, Treatment, and Genetic perturbation."

lib_size <- data.frame(
  Sample = colnames(data),
  Counts_Millions = colSums(data) / 1e6
) %>%
  mutate(
    Cell_Line = ifelse(str_detect(Sample, "LNCaP"), "LNCaP", "PC3"),
    Condition = factor(ifelse(str_detect(Sample, "Hypoxia"), "Hypoxia", "Normoxia"), 
                       levels = c("Normoxia", "Hypoxia")),
    Replicate = str_extract(Sample, "(rep|siRNA)[1-2]$"),
    Treatment = case_when(
      str_detect(Sample, "EV") ~ "Empty Vector",
      str_detect(Sample, "overexpress") ~ "OC2 Overexpression",
      str_detect(Sample, "siCtrl") ~ "siCtrl",
      str_detect(Sample, "siOC2") ~ "siOC2",
      TRUE ~ "Other"
    )
  )

ggplot(lib_size, aes(x = Condition, y = Counts_Millions, fill = Replicate)) +
  geom_col(position = position_dodge(width = 0.8), width = 0.7) +
  facet_grid(. ~ Cell_Line + Treatment, scales = "free_x", space = "free_x", switch = "x") +
  # Teal gradient for reps, Blue gradient for siRNA to distinguish experimental designs
  scale_fill_manual(values = c("rep1" = "#16A085", "rep2" = "#0E6655", 
                               "siRNA1" = "#2980B9", "siRNA2" = "#1A5276")) +
  theme_minimal() +
  theme(strip.placement = "outside", 
        strip.text = element_text(size = 9, face = "bold"),
        legend.position = "top") +
  labs(title = "Total counts per sample",
       y = "Total Read Counts (Million)", x = NULL)
```

LNCaP samples show consistent read depths across conditions. Conversly, PC3 replicates indicate noticeable variability in depth. These differences in sequencing can be addressed using size-factor normalization or other normalization methods during differential expression analysis.

```{r}
#| fig-width: 10
#| fig-height: 5
#| fig-cap: "Figure 2: Distribution of Log2-transformed counts."

data_long <- data %>%
  rownames_to_column("Gene") %>%
  pivot_longer(-Gene, names_to = "Sample", values_to = "Counts") %>%
  filter(Counts > 0) %>% 
  left_join(lib_size, by = "Sample")

ggplot(data_long, aes(x = Condition, y = log2(Counts + 1), fill = Replicate)) +
  geom_boxplot(outlier.size = 0.2, alpha = 0.7, outlier.alpha = 0.1) +
  facet_grid(. ~ Cell_Line + Treatment, scales = "free_x", space = "free_x", switch = "x") +
  scale_fill_manual(values = c("rep1" = "#16A085", "rep2" = "#0E6655", 
                               "siRNA1" = "#2980B9", "siRNA2" = "#1A5276")) +
  theme_minimal() +
  theme(strip.placement = "outside", legend.position = "top") +
  labs(title = "Global Gene Expression Distributions",
       y = expression(Log[2] * "(Counts + 1)"), x = NULL)
```

Global expression profiles are relatively consistent across samples, with median log2 counts ranging between 7.5 and 8.0. However, we can notice some extreme high-count outliers (\>20 on the log2 scale).

```{r}
#| fig-width: 14
#| fig-height: 10
#| fig-dpi: 300
#| fig-cap: "Figure-3:Pearson correlation of log2-transformed counts for replicates per group"

# 1. Prepare Data (Same logic as before)
corr_data <- data %>%
  rownames_to_column("Gene") %>%
  pivot_longer(-Gene, names_to = "Sample", values_to = "Counts") %>%
  mutate(
    Group = str_remove(Sample, "_(rep|siRNA)[1-2]$"),
    Replicate = paste0("Rep_", str_extract(Sample, "[1-2]$"))
  ) %>%
  select(-Sample) %>%
  pivot_wider(names_from = Replicate, values_from = Counts)

# 2. Plot with Statistical Annotation
ggplot(corr_data, aes(x = log2(Rep_1 + 1), y = log2(Rep_2 + 1))) +
  geom_bin2d(bins = 100) + 
  scale_fill_viridis_c(option = "mako", trans = "log10") +
  geom_abline(intercept = 0, slope = 1, color = "red", linetype = "dashed") +
  facet_wrap(~Group, ncol = 4) +
  # Add Correlation Coefficient and P-value
  stat_cor(method = "pearson", 
           label.x = 1,      # X-position for label
           label.y = 22,     # Y-position for label
           size = 5, 
           color = "black",
           fontface = "bold") +
  theme_minimal() +
  theme(
    strip.text = element_text(size = 12, face = "bold"),
    legend.position = "right",
    plot.title = element_text(face = "bold", hjust = 0.5)
  ) +
  labs(
    title = "Correlation between replicates",
    x = "Rep-1 Log2(Count + 1)",
    y = "Rep-2 Log2(Count + 1)",
    fill = "Gene Count",
  )
```

Replicates demonstrate high correlation (R \>= 0.95), indicating robust reproducibility across all experimental conditions.

## 3. Library Composition

Lets investigate the highly abundant transcripts identified in Figure 2 to determine if they represent biologically relevant signals or technical artifacts.

```{r}
#| fig-width: 14
#| fig-height: 10
#| fig-dpi: 300
#| fig-cap: "Figure-4:Genes with highest count"
# 1. Prepare Data
top_genes_plot_data <- data %>%
  rownames_to_column(var = "Gene") %>%
  pivot_longer(cols = -Gene, names_to = "Sample", values_to = "Counts") %>%
  group_by(Sample) %>%
  slice_max(order_by = Counts, n = 3, with_ties = FALSE) %>% 
  ungroup() %>%
  mutate(Gene_Sorted = tidytext::reorder_within(Gene, Counts, Sample))


# My preferred colors but you can define your own
pref_colors <- c(
  "#2C3E50", "#16A085", "#2980B9", "#8E44AD", "#117A65",
  "#D35400", "#C0392B", "#7F8C8D", "#1F618D","#273746",
  "#A04000", "#1D8348", "#512E5F", "#922B21","#1B2631"
)

#plot the top genes
ggplot(top_genes_plot_data, aes(y = Gene_Sorted, x = Counts, fill = Gene)) +
  geom_col(show.legend = FALSE, width = 0.8) +
  geom_text(aes(label = Gene), hjust = 1.1, size = 5, color = "white", fontface = "bold") +
  tidytext::scale_y_reordered() +
  scale_x_log10(labels = scales::label_log(), breaks = scales::log_breaks(n = 3)) +
  facet_wrap(~Sample, scales = "free_y", ncol = 4) + 
  scale_fill_manual(values = pref_colors) +
  theme_minimal() +
  theme(axis.text.y = element_blank(),
        strip.text = element_text(face = "bold", size = 11),
        strip.background = element_rect(fill = "#F4F6F7", color = NA)) +
  labs(title = "Top 3 Most Highly Expressed Genes per sample",
       x = "Raw Read Counts (Log10)", y = NULL)
```

The most abundant transcripts are consistent across samples. Mitochondrial and *RNA45SN* genes dominate across samples. Crucially, *ONECUT2* appears as a top gene in OC2 overexpression samples, validating the experimental setup.

Given the prevalence of mitochondrial transcripts, lets quantify the exact proportion of the library they occupy per sample. Additionally, we can inspect the ribosomal content to confirm the efficiency of the Poly-A selection.

```{r}
#| fig-width: 10
#| fig-height: 5
#| fig-cap: "Figure-5: "
#| 
qc_summary <- data %>%
  rownames_to_column(var = "Gene") %>%
  pivot_longer(cols = -Gene, names_to = "Sample", values_to = "Counts") %>%
  mutate(
    Type = case_when(
      grepl("^MT-", Gene) ~ "Mitochondrial",
      grepl("^RP[SL]|^RNA45S|^RNR[12]", Gene) ~ "Ribosomal",
      TRUE ~ "Nuclear/Other"
    )
  ) %>%
  group_by(Sample, Type) %>%
  summarise(Type_Total = sum(Counts), .groups = "drop") %>%
  group_by(Sample) %>%
  mutate(Percentage = (Type_Total / sum(Type_Total)) * 100,
         Cell_Line = ifelse(str_detect(Sample, "LNCaP"), "LNCaP", "PC3"))

#plotting 
ggplot(qc_summary, aes(x = Sample, y = Percentage, fill = Type)) +
  geom_col(width = 0.7) +
  geom_text(aes(label = paste0(round(Percentage, 0), "%")), 
            position = position_stack(vjust = 0.5), size = 3, color = "white", fontface = "bold") +
  facet_wrap(~Cell_Line, scales = "free_x") +
  scale_fill_manual(values = c("Nuclear/Other" = "#117A65", "Mitochondrial" = "#C0392B", "Ribosomal" = "#F39C12")) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 60, hjust = 1), legend.position = "right") +
  labs(title = "Library Composition by Gene Category", y = "Percentage of Total Reads", x = NULL)
```

PC3 samples have a significantly higher mitochondrial burden (\~45%) compared to LNCaP. This could be result of a different metabolic profile or technical artifacts between the two cell lines.
