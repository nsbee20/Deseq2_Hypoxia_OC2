---
title: "Differential Gene expression analysis using Deseq2"
author: "Nitin Beesabathuni"
date: "`r Sys.Date()`"
format: 
  html:
    toc: true
    toc-depth: 2
    code-fold: true
    theme: cosmo
---

Summary: This report focuses on identifying differential expressed genes under hypoxic conditions and to understand the influence of overexpressing or knocking downs OC2 in LNCAP and PC3 cells, respectively.

```{r}
#| results: false
#| message: false
# Load necessary library
library(tidyverse)
library(here)
library(conflicted)
library(DESeq2)
library(ggplot2)
library(ggpubr) 
library(scales) # For readable axis labels
library(gt)
library(DESeq2)
library(pheatmap)
library(RColorBrewer)
library(patchwork)
library(ggplotify)
# Resolve namespace conflicts
conflict_prefer("select", "dplyr")
conflict_prefer("filter", "dplyr")
conflicts_prefer(generics::setdiff)

#loading functions
source("functions.R")
```

## 1. Data Import and Metadata Preparation

Importing the annotated count matrix. Gene symbols are used as primary identifiers.

```{r}
# Loading cleaned and annotated data for both cell types
data <- read.csv("analysis_ready_count_data.csv", row.names = 1, check.names = FALSE)

#Separting data for both cell types into their respective dfs

data_lncap <- data %>%
  select(contains("LNCaP"))

data_pc3 <- data %>%
  select(contains("PC3"))

# 1. Sanitize the column names of your dataframes immediately
# This replaces dashes or illegal characters with dots (e.g., rep-1 becomes rep.1)
colnames(data_lncap) <- make.names(colnames(data_lncap))
colnames(data_pc3) <- make.names(colnames(data_pc3))

# 2. Define the metadata vectors
condition <- c(rep("Normoxia", 4), rep("Hypoxia", 4))
overexpress <- c(rep("Empty_vector", 2), rep("OC2_Overexpress", 2), 
                 rep("Empty_vector", 2), rep("OC2_Overexpress", 2))
knockdown <- c(rep("siCtrl", 2), rep("siOC2", 2), 
               rep("siCtrl", 2), rep("siOC2", 2))

# 3. Create the data frames with explicit row names from the sanitized columns
# We also use stringsAsFactors = TRUE or explicitly wrap in factor() for DESeq2
meta_lncap <- data.frame(
  Treatment = factor(condition, levels = c("Normoxia", "Hypoxia" )),
  Genetic_perturbation = factor(overexpress, levels = c("Empty_vector", "OC2_Overexpress")),
  row.names = colnames(data_lncap) 
)

meta_pc3 <- data.frame(
  Treatment = factor(condition, levels = c("Normoxia", "Hypoxia")),
  Genetic_perturbation = factor(knockdown, levels = c("siCtrl", "siOC2")),
  row.names = colnames(data_pc3)
)

# CRITICAL CHECK: DESeq2 will fail if these are not identical
stopifnot(all(colnames(data_lncap) == rownames(meta_lncap)))
stopifnot(all(colnames(data_pc3) == rownames(meta_pc3)))
```

## 2. Data QC for any technical artifacts

Before we identify genes that are differential expressed lets examine if there are any technical artifacts such as sample variability to identify any outlier samples. We can look at two things- PCA and hierarchical clustering. Note- in counts QC script we already saw the replicates had high correlation but its always better to check how the samples behave in the high-dimensional and when compared to other samples.

```{r}
#| fig-width: 6
#| fig-height: 4
#| fig-dpi: 300
##defining deseq2 object
dds_pc3<- DESeqDataSetFromMatrix(countData = data_pc3,
                              colData = meta_pc3,
                              design = ~Treatment*Genetic_perturbation)   
dds_lncap<- DESeqDataSetFromMatrix(countData = data_lncap,
                              colData = meta_lncap,
                              design = ~Treatment*Genetic_perturbation) 
#| message: false
# For PC3
pc3_QC<-QC_pca_heatmap(dds_pc3, meta_pc3,cell_line_name = "PC3")

# For LNCaP
lncap_QC<-QC_pca_heatmap(dds_lncap, meta_lncap,cell_line_name = "LNCaP")

```

```{r}
#| fig-width: 10
#| fig-height: 3
#| fig-dpi: 300
#PCA for both the cell lines across two treatments and genetic perturbations. 
lncap_QC$pca+ pc3_QC$pca 
```

For LNCaP cells, we nicley see the four cluster based on the treatment-genetic perturbation. Moreover, PC1 explains \~56% of the variance which differentiates treatment effects. While, PC2 explains about \~37% and explains the effect of over expression of OC2. So for these samples, we dont see any extreme outlier samples or technical artifacts.

For PC3 samples, we see an interesting behavior. We see a strong separation between siCtrl and siOC2 samples but within siOC2 samples, we see two separate clusters. We can also see the siOC2 samples cluster together regardless of the treatment conditions. Lets examine the heatmap to see why there are two clusters within siOC2 samples.

```{r}
#| fig-width: 8
#| fig-height: 5
#| fig-dpi: 300
#heatmap for pc3 cells
pc3_QC$heatmap
```

Based on the heatmap, we see another latent variable- the siRNA used. We can see the siRNA specific samples cluster more strongly together regardless of the treatment. Theoretically, if the treatment effects are stronger we would expect the siRNA1 and siRNA2 to cluster together based on the treatment. However, we see a stronger correlation between the same siRNA's used for knockdown of OC2 regardless of the treatment. This could perhaps be a result of knockdown of OC2 which rescues some aspects of hypoxia driven cellular changes (not fully). Moreover, we also see the siRNA's under normoxia cluster separately so there could be some off target activity of the specific siRNA used to knockdown OC2.

```{r}
#| fig-width: 8
#| fig-height: 5
#| fig-dpi: 300
#heatmap for lncap cells
lncap_QC$heatmap
```

For LNCaP cells, the replicates cluster together based on the treatment and genetic perturbation as expected.

```{}
```

```{r}
#lets perform differential expression analysis using deseq2 to ask various questions. 
dds_lncap <- DESeq(dds_lncap)
dds_pc3<-DESeq(dds_pc3)
```

You can see various steps that are performed by this function. Briefly,

1\) We normalize each sample with their respective size factors calculated by using median of ratios method.

2\) As the
