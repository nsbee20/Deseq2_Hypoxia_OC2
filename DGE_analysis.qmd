---
title: "Analyzing and QC Counts_QC_before_DE"
format: html
editor: visual
---

```{r}
#| results: false
#| message: false
# Load necessary library
library(tidyverse)
library(here)
library(conflicted)
library(DESeq2)
library(ggplot2)
library(scales) # For readable axis labels
# Force R to use dplyr for select and filter
conflict_prefer("select", "dplyr")
conflict_prefer("filter", "dplyr")
conflicts_prefer(generics::setdiff)
```

You can add options to executable code like this

```{r}
#loading cleaned and annotated data
data <- read.csv("analysis_ready_count_data.csv", row.names = 1, check.names = FALSE)

#quick view of data imported- should have gene symbols as rowname and hypoxia data for two cell lines and treatment conditions as columns
head(data)

#replacing the column names with smaller readble names
colnames(data) <- colnames(data) %>%
  str_replace_all("Empty_Vector", "EV") %>%
  str_replace_all("_RNA-Seq", "")

```

```{r}
#plotting total counts per sample
#| results: false
summary(data)
```

The max in each sample is much higher than median/mean counts/sample, indicating genes with extreme counts (probably outliers). Lets look at the genes that are on the top end for each sample

```{r}
top_genes_table <- data %>%
  rownames_to_column(var = "Gene") %>%
  pivot_longer(cols = -Gene, names_to = "Sample", values_to = "Counts") %>%
  group_by(Sample) %>%
  slice_max(order_by = Counts, n = 5) %>%
  arrange(Sample, desc(Counts))

print(top_genes_table)
```

Most of these genes are mitochondrial or Ribosomal.

```{r}
#| fig-width: 6.5
#| fig-height: 4
#| fig-dpi: 300
#| layout-ncol: 1
# 1. Calculate the proportions of counts from mito/ribosomal and (efficiently grouping by Type)
qc_summary <- data %>%
  rownames_to_column(var = "Gene") %>%
  pivot_longer(cols = -Gene, names_to = "Sample", values_to = "Counts") %>%
  mutate(
    Type = case_when(
      grepl("^MT-", Gene) ~ "Mitochondrial",
      grepl("^RP[SL]|^RNA45S|^RNR[12]", Gene) ~ "Ribosomal",
      TRUE ~ "Nuclear/Other"
    )
  ) %>%
  group_by(Sample, Type) %>%
  summarise(Type_Total = sum(Counts), .groups = "drop") %>%
  group_by(Sample) %>%
  mutate(Percentage = (Type_Total / sum(Type_Total)) * 100) %>%
  mutate(Cell_Line = ifelse(str_detect(Sample, "LNCaP"), "LNCaP", "PC3"))

#plot bar graph
ggplot(qc_summary, aes(x = Sample, y = Percentage, fill = Type)) +
  geom_col(width = 0.7, lineend = "round", linejoin = "round") +
  geom_text(aes(label = paste0(round(Percentage, 1), "%")), 
            position = position_stack(vjust = 0.5), 
            size = 1.5,           # Shrunk text inside bars
            color = "white", 
            fontface = "bold") +
  facet_wrap(~Cell_Line, scales = "free_x") +
  scale_fill_manual(values = c(
    "Nuclear/Other" = "#16A085", 
    "Mitochondrial" = "#C0392B", 
    "Ribosomal"     = "#F39C12"
  )) +
  theme_minimal() +
  theme(
    # --- Axis and Labels ---
    axis.text.x = element_text(angle = 50, hjust = 1, size = 6),
    axis.text.y = element_text(size = 6),
    axis.title.y = element_text(size = 7),
    
    # --- Subplot Headers (LNCaP / PC3) ---
    strip.text = element_text(size = 7, face = "bold"), 
    
    # --- Legend (Making it much smaller) ---
    legend.title = element_text(size = 7),
    legend.text = element_text(size = 6),
    legend.key.size = unit(0.3, "cm"), # Reduces the size of the color boxes
    
    # --- Main Title ---
    plot.title = element_text(size = 9, face = "bold", hjust = 0.5),
    
    # --- Spacing ---
    plot.margin = margin(t = 5, r = 5, b = 5, l = 15),
    panel.spacing = unit(1, "lines") # Adds a clear gap between the two subplots
  ) +
  labs(title = "Library Composition by Cell Line/Condition",
       y = "Percentage of Total Reads (%)", 
       x = NULL)

```

The mitochondria and Ribosomal RNA counts are relatively low compared to the rest of the counts in LNCaP samples while PC3 samples show high mitochondrial gene counts across all samples. We see this behavior across normal and hypoxia samples so it could be a technical artifact.

```{r}
# 1. Calculate column sums and convert to a data frame for plotting
# Calculate library sizes in millions#| fig-width: 12
#| fig-width: 8
#| fig-height: 4
#| fig-dpi: 300

# 1. Enhance Metadata
lib_size <- data.frame(
  Sample = colnames(data),
  Counts_Millions = colSums(data) / 1e6
) %>%
  mutate(
    Cell_Line = ifelse(str_detect(Sample, "LNCaP"), "LNCaP", "PC3"),
    
    # --- FIX: Set factor levels so Normoxia is first ---
    Condition = factor(ifelse(str_detect(Sample, "Hypoxia"), "Hypoxia", "Normoxia"), 
                       levels = c("Normoxia", "Hypoxia")),
    
    Replicate = str_extract(Sample, "(rep|siRNA)[1-2]$"),
    Treatment = case_when(
      str_detect(Sample, "EV") ~ "EV",
      str_detect(Sample, "overexpress") ~ "OC2 OE",
      str_detect(Sample, "siCtrl") ~ "siCtrl",
      str_detect(Sample, "siOC2") ~ "siOC2",
      TRUE ~ "Other"
    )
  )

# 2. Plotting every sample separately
ggplot(lib_size, aes(x = Condition, y = Counts_Millions, fill = Replicate)) +
  geom_col(position = position_dodge(width = 0.8), width = 0.7, lineend = "round", linejoin = "round") +
  # Nested facets: Cell_Line then Treatment
  facet_grid(. ~ Cell_Line + Treatment, scales = "free_x", space = "free_x", switch = "x") +
  # Using your professional muted palette (Teal for Rep1, Terracotta for Rep2)
  scale_fill_manual(values = c(
    "rep1" = "#16A085", "rep2" = "#0E6655",
    "siRNA1" = "#16A085", "siRNA2" = "#0E6655"
  )) +
  theme_minimal() +
  theme(
    strip.placement = "outside",
    strip.text = element_text(size = 8, face = "bold"),
    axis.text.x = element_text(size = 7, angle = 45, hjust = 1),
    panel.spacing.x = unit(1, "lines"),
    legend.position = "top",
    legend.title = element_text(size = 8),
    legend.text = element_text(size = 7),
    plot.title = element_text(hjust = 0.5, face = "bold", size = 10)
  ) +
  labs(
    title = "Total counts: Normoxia vs Hypoxia by Replicate",
    y = expression("Total Read Counts (" * 10^6 * ")"),
    x = NULL # Removed "Experimental Groups" for a cleaner look since facets cover it
  )
```

LNCap counts are relatively consistent across all samples while we observe variability even within replicates for PC3 samples for overall counts.
